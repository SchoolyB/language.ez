---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import errorsData from '../../data/errors.json';

const base = import.meta.env.BASE_URL;

// Group errors by category
const errorsByCategory = errorsData.categories.map(category => {
  const categoryErrors = errorsData.errors.filter(e => e.category === category.id);
  return {
    ...category,
    count: categoryErrors.length,
    errors: categoryErrors,
  };
});

const totalErrors = errorsData.errors.length;
---

<BaseLayout title="Error Reference - EZ" description="Complete reference of all EZ error and warning codes.">
  <Header />

  <main class="flex-1 max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <h1 class="text-3xl font-bold mb-4 text-black dark:text-white">Error Reference</h1>
    <p class="opacity-70 mb-8 text-black dark:text-white">
      EZ has <span class="text-xl font-bold opacity-100">{totalErrors}</span> error and warning codes to help you understand exactly what went wrong and how to fix it.
    </p>

    <!-- Search -->
    <div class="mb-8">
      <div class="relative">
        <input
          type="search"
          id="error-search"
          placeholder="Search errors... (e.g., E1004, unclosed string)"
          class="w-full px-4 py-3 pl-10 border border-gray-200 dark:border-gray-800 rounded-lg bg-white dark:bg-black text-black dark:text-white focus:outline-none focus:ring-2 focus:ring-black dark:focus:ring-white"
        />
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 opacity-40" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>
    </div>

    <!-- Search Results (hidden by default) -->
    <div id="search-results" class="hidden mb-8">
      <h2 class="text-lg font-semibold mb-4 text-black dark:text-white">Search Results</h2>
      <div id="search-results-list" class="grid gap-2"></div>
      <p id="no-results" class="hidden text-center opacity-60 py-8">No errors found matching your search.</p>
    </div>

    <!-- Error Categories -->
    <div id="categories" class="space-y-6">
      {errorsByCategory.map(category => (
        <div class="border border-[#e5e5e5] dark:border-[#333333] rounded-lg overflow-hidden">
          <div class="px-4 py-4 bg-[#f5f5f5] dark:bg-[#1a1a1a]">
            <div class="flex items-center justify-between mb-2">
              <h2 class="text-lg font-semibold text-black dark:text-white">
                {category.name}
                <span class="font-mono text-sm opacity-60 ml-2">({category.range})</span>
              </h2>
              <span class="text-sm opacity-60 text-black dark:text-white">{category.count} codes</span>
            </div>
            <p class="text-sm opacity-70 mb-4 text-black dark:text-white">{category.description}</p>
            <div class="flex flex-wrap gap-2">
              {category.errors.slice(0, 8).map(error => (
                <a
                  href={`${base}errors/${error.code}`}
                  class="text-xs px-2.5 py-1.5 bg-white dark:bg-black rounded border border-gray-200 dark:border-gray-800 hover:border-black dark:hover:border-white transition-colors font-mono text-black dark:text-white"
                >
                  {error.code}
                </a>
              ))}
              {category.errors.length > 8 && (
                <button
                  class="show-all-btn text-xs px-2.5 py-1.5 opacity-50 hover:opacity-100 transition-opacity text-black dark:text-white"
                  data-category={category.id}
                >
                  +{category.errors.length - 8} more
                </button>
              )}
            </div>
            <!-- Hidden expanded list -->
            <div id={`expanded-${category.id}`} class="hidden mt-3 pt-3 border-t border-[#e5e5e5] dark:border-[#333333]">
              <div class="flex flex-wrap gap-2">
                {category.errors.slice(8).map(error => (
                  <a
                    href={`${base}errors/${error.code}`}
                    class="text-xs px-2.5 py-1.5 bg-white dark:bg-black rounded border border-gray-200 dark:border-gray-800 hover:border-black dark:hover:border-white transition-colors font-mono text-black dark:text-white"
                  >
                    {error.code}
                  </a>
                ))}
              </div>
            </div>
          </div>
        </div>
      ))}
    </div>

    <!-- All Errors Table -->
    <div class="mt-12" id="all-errors-section">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-black dark:text-white">All Error Codes ({totalErrors})</h2>
        <button
          id="show-all-errors-btn"
          class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-black dark:text-white bg-white dark:bg-black border border-gray-300 dark:border-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-900 transition-colors"
        >
          <span id="expand-icon">▶</span>
          <span id="expand-text">Show all</span>
        </button>
      </div>
      <div id="errors-table-container" class="hidden border border-[#e5e5e5] dark:border-[#333333] rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="bg-[#f5f5f5] dark:bg-[#1a1a1a] border-b border-[#e5e5e5] dark:border-[#333333]">
                <th class="px-4 py-3 text-left font-semibold text-black dark:text-white">Code</th>
                <th class="px-4 py-3 text-left font-semibold text-black dark:text-white">Name</th>
                <th class="px-4 py-3 text-left font-semibold text-black dark:text-white hidden sm:table-cell">Message</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-[#e5e5e5] dark:divide-[#333333]">
              {errorsData.errors.map((error) => (
                <tr
                  class="hover:bg-[#f5f5f5] dark:hover:bg-[#1a1a1a] transition-colors error-row"
                  data-code={error.code.toLowerCase()}
                  data-slug={error.slug}
                  data-message={error.message.toLowerCase()}
                >
                  <td class="px-4 py-3">
                    <a href={`${base}errors/${error.code}`} class="font-mono text-black dark:text-white hover:underline">
                      {error.code}
                    </a>
                  </td>
                  <td class="px-4 py-3">
                    <a href={`${base}errors/${error.code}`} class="hover:underline opacity-80 text-black dark:text-white">
                      {error.slug}
                    </a>
                  </td>
                  <td class="px-4 py-3 opacity-60 hidden sm:table-cell text-black dark:text-white">{error.message}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
        <div class="px-4 py-3 bg-[#f5f5f5] dark:bg-[#1a1a1a] border-t border-[#e5e5e5] dark:border-[#333333] text-center">
          <button
            id="hide-errors-btn"
            class="flex items-center gap-2 mx-auto px-4 py-2 text-sm font-medium text-black dark:text-white bg-white dark:bg-black border border-gray-300 dark:border-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-900 transition-colors"
          >
            <span>▲</span>
            <span>Hide all</span>
          </button>
        </div>
      </div>
    </div>
  </main>

  <Footer />
</BaseLayout>

<script>
  // Elements
  const searchInput = document.getElementById('error-search') as HTMLInputElement;
  const searchResults = document.getElementById('search-results');
  const noResults = document.getElementById('no-results');
  const categories = document.getElementById('categories');
  const errorRows = document.querySelectorAll('.error-row');
  const showAllBtn = document.getElementById('show-all-errors-btn');
  const hideErrorsBtn = document.getElementById('hide-errors-btn');
  const tableContainer = document.getElementById('errors-table-container');
  const allErrorsSection = document.getElementById('all-errors-section');
  const expandIcon = document.getElementById('expand-icon');
  const expandText = document.getElementById('expand-text');

  let isExpanded = false;

  function collapseTable() {
    isExpanded = false;
    tableContainer?.classList.add('hidden');
    if (expandIcon) expandIcon.textContent = '▶';
    if (expandText) expandText.textContent = 'Show all';
  }

  function expandTable() {
    isExpanded = true;
    tableContainer?.classList.remove('hidden');
    if (expandIcon) expandIcon.textContent = '▼';
    if (expandText) expandText.textContent = 'Hide all';
  }

  // Toggle table visibility (top button)
  showAllBtn?.addEventListener('click', () => {
    if (isExpanded) {
      collapseTable();
    } else {
      expandTable();
    }
  });

  // Hide button at bottom - collapse and scroll to section
  hideErrorsBtn?.addEventListener('click', () => {
    collapseTable();
    allErrorsSection?.scrollIntoView({ behavior: 'smooth' });
  });

  // Category expand buttons
  document.querySelectorAll('.show-all-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const category = (btn as HTMLButtonElement).dataset.category;
      const expanded = document.getElementById(`expanded-${category}`);
      if (expanded) {
        expanded.classList.toggle('hidden');
        btn.textContent = expanded.classList.contains('hidden')
          ? btn.textContent
          : 'Show less';
      }
    });
  });

  // Search
  searchInput?.addEventListener('input', (e) => {
    const query = (e.target as HTMLInputElement).value.toLowerCase().trim();

    if (!query) {
      // No search query - show categories, reset table to collapsed/expanded state
      searchResults?.classList.add('hidden');
      categories?.classList.remove('hidden');
      errorRows.forEach(row => {
        (row as HTMLElement).style.display = '';
      });
      // Restore table visibility based on expanded state
      if (isExpanded) {
        tableContainer?.classList.remove('hidden');
      } else {
        tableContainer?.classList.add('hidden');
      }
      return;
    }

    // Has search query - hide categories, show table, filter rows
    categories?.classList.add('hidden');
    searchResults?.classList.remove('hidden');
    tableContainer?.classList.remove('hidden');

    // Filter table rows
    let matchCount = 0;
    errorRows.forEach(row => {
      const el = row as HTMLElement;
      const code = el.dataset.code || '';
      const slug = (el.dataset.slug || '').toLowerCase();
      const message = el.dataset.message || '';

      if (code.includes(query) || slug.includes(query) || message.includes(query)) {
        el.style.display = '';
        matchCount++;
      } else {
        el.style.display = 'none';
      }
    });

    // Update results count and no results message
    const searchResultsList = document.getElementById('search-results-list');
    if (searchResultsList) {
      searchResultsList.innerHTML = `<p class="text-sm opacity-70">Found ${matchCount} error${matchCount !== 1 ? 's' : ''} matching "${query}"</p>`;
    }

    if (matchCount === 0) {
      noResults?.classList.remove('hidden');
    } else {
      noResults?.classList.add('hidden');
    }
  });
</script>
