---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import CodeBlock from '../../components/CodeBlock.astro';
import errorsData from '../../data/errors.json';

export function getStaticPaths() {
  return errorsData.errors.map((error) => ({
    params: { code: error.code },
    props: { error },
  }));
}

interface Props {
  error: {
    code: string;
    slug: string;
    message: string;
    usedFor: string;
    example: string;
    category: string;
    suppressible?: string;
    howToFix?: string;
    relatedErrors?: string[];
  };
}

const { error } = Astro.props;
const category = errorsData.categories.find((c) => c.id === error.category);
const isWarning = error.code.startsWith('W');
const base = import.meta.env.BASE_URL;

// Get adjacent errors for navigation
const currentIndex = errorsData.errors.findIndex((e) => e.code === error.code);
const prevError = currentIndex > 0 ? errorsData.errors[currentIndex - 1] : null;
const nextError = currentIndex < errorsData.errors.length - 1 ? errorsData.errors[currentIndex + 1] : null;
---

<BaseLayout title={`${error.code}: ${error.slug} - EZ Errors`}>
  <Header />

  <main class="flex-1">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <!-- Breadcrumb -->
      <nav class="mb-8 text-sm">
        <ol class="flex items-center gap-2 opacity-60">
          <li><a href={base} class="hover:opacity-100">Home</a></li>
          <li>/</li>
          <li><a href={`${base}errors`} class="hover:opacity-100">Errors</a></li>
          <li>/</li>
          <li class="opacity-100 font-medium">{error.code}</li>
        </ol>
      </nav>

      <!-- Header -->
      <header class="mb-8">
        <div class="flex items-center gap-3 mb-4">
          <span class:list={[
            'px-3 py-1 rounded-full text-sm font-mono font-semibold',
            isWarning
              ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200'
              : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
          ]}>
            {error.code}
          </span>
          {category && (
            <span class="text-sm opacity-60">{category.name}</span>
          )}
        </div>
        <h1 class="text-3xl sm:text-4xl font-bold mb-2 text-black dark:text-white">
          {error.slug}
        </h1>
        <p class="text-xl opacity-70">{error.message}</p>
      </header>

      <!-- Main content -->
      <div class="space-y-8">
        <!-- When this occurs -->
        <section>
          <h2 class="text-xl font-semibold mb-3 text-black dark:text-white">When this occurs</h2>
          <p class="opacity-80">{error.usedFor}</p>
        </section>

        <!-- Example message -->
        <section>
          <h2 class="text-xl font-semibold mb-3 text-black dark:text-white">Example error message</h2>
          <div class="bg-gray-100 dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-lg p-4 font-mono text-sm">
            <span class:list={[
              'font-semibold',
              isWarning ? 'text-yellow-600 dark:text-yellow-400' : 'text-red-600 dark:text-red-400'
            ]}>
              {isWarning ? 'warning' : 'error'}[{error.code}]:
            </span>
            <span class="opacity-80"> {error.example}</span>
          </div>
        </section>

        <!-- Suppressible warning -->
        {error.suppressible && (
          <section>
            <h2 class="text-xl font-semibold mb-3 text-black dark:text-white">Suppressing this warning</h2>
            <p class="opacity-80 mb-3">This warning can be suppressed using:</p>
            <code class="bg-gray-100 dark:bg-gray-900 px-3 py-1.5 rounded border border-gray-200 dark:border-gray-800 font-mono text-sm">
              {error.suppressible}
            </code>
          </section>
        )}

        <!-- How to fix -->
        <section class="border-t border-gray-200 dark:border-gray-800 pt-8">
          <h2 class="text-xl font-semibold mb-3 text-black dark:text-white">How to fix</h2>
          {error.howToFix ? (
            <p class="opacity-80">{error.howToFix}</p>
          ) : (
            <p class="opacity-60 italic">
              Detailed fix instructions will be added in a future update.
            </p>
          )}
        </section>

        <!-- Related errors -->
        <section class="border-t border-gray-200 dark:border-gray-800 pt-8">
          <h2 class="text-xl font-semibold mb-3 text-black dark:text-white">Related errors</h2>
          {error.relatedErrors && error.relatedErrors.length > 0 ? (
            <div class="flex flex-wrap gap-2">
              {error.relatedErrors.map((relatedCode) => {
                const relatedError = errorsData.errors.find((e) => e.code === relatedCode);
                return relatedError ? (
                  <a
                    href={`${base}errors/${relatedCode}`}
                    class="inline-flex items-center gap-2 px-3 py-1.5 bg-gray-100 dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-lg hover:border-gray-400 dark:hover:border-gray-600 transition-colors"
                  >
                    <span class="font-mono text-sm font-medium">{relatedCode}</span>
                    <span class="text-sm opacity-60">- {relatedError.slug}</span>
                  </a>
                ) : (
                  <span class="inline-flex items-center px-3 py-1.5 bg-gray-100 dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-lg font-mono text-sm">
                    {relatedCode}
                  </span>
                );
              })}
            </div>
          ) : (
            <p class="opacity-60 italic">No related errors.</p>
          )}
        </section>
      </div>

      <!-- Navigation -->
      <nav class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-800">
        <div class="flex justify-between">
          {prevError ? (
            <a
              href={`${base}errors/${prevError.code}`}
              class="flex items-center gap-2 opacity-60 hover:opacity-100 transition-opacity"
            >
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
              </svg>
              <span class="text-sm">
                <span class="font-mono">{prevError.code}</span>
                <span class="hidden sm:inline opacity-60 ml-1">- {prevError.slug}</span>
              </span>
            </a>
          ) : (
            <div></div>
          )}
          {nextError ? (
            <a
              href={`${base}errors/${nextError.code}`}
              class="flex items-center gap-2 opacity-60 hover:opacity-100 transition-opacity"
            >
              <span class="text-sm">
                <span class="font-mono">{nextError.code}</span>
                <span class="hidden sm:inline opacity-60 ml-1">- {nextError.slug}</span>
              </span>
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
              </svg>
            </a>
          ) : (
            <div></div>
          )}
        </div>
      </nav>
    </div>
  </main>

  <Footer />
</BaseLayout>
