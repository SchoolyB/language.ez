---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { marked } from 'marked';

// Fetch releases from GitHub at build time
const response = await fetch('https://api.github.com/repos/SchoolyB/EZ/releases', {
  headers: {
    'Accept': 'application/vnd.github.v3+json',
    'User-Agent': 'EZ-Docs-Site'
  }
});

interface GitHubRelease {
  id: number;
  tag_name: string;
  name: string;
  body: string;
  published_at: string;
  html_url: string;
  prerelease: boolean;
  draft: boolean;
}

let releases: GitHubRelease[] = [];

if (response.ok) {
  const data = await response.json();
  releases = data.filter((r: GitHubRelease) => !r.draft);
}

// Format date helper
function formatDate(dateString: string): string {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

// Parse markdown to HTML
function parseMarkdown(content: string): string {
  if (!content) return '<p>No release notes available.</p>';
  return marked.parse(content) as string;
}
---

<BaseLayout title="Changelog - EZ" description="Release history and changelog for the EZ programming language.">
  <Header />

  <div class="flex-1 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="lg:grid lg:grid-cols-[1fr_200px] lg:gap-8">
      <!-- Main Content -->
      <main class="min-w-0">
        <h1 class="text-3xl font-bold mb-2">Changelog</h1>
        <p class="opacity-60 mb-8">
          Release history for the EZ programming language. See what's new in each version.
        </p>

        {releases.length === 0 ? (
          <div class="text-center py-12 opacity-60">
            <p>Unable to load releases. Please check the <a href="https://github.com/SchoolyB/EZ/releases" class="underline hover:opacity-80">GitHub releases page</a>.</p>
          </div>
        ) : (
          <div class="space-y-8">
            {releases.map((release, index) => (
              <article
                id={release.tag_name}
                class="release-entry scroll-mt-24 rounded-lg overflow-hidden"
                style="border: 1px solid var(--ez-gray-border);"
                data-version={release.tag_name}
              >
                <header class="px-6 py-4" style="background-color: var(--ez-gray-bg); border-bottom: 1px solid var(--ez-gray-border);">
                  <div class="flex items-center gap-3 flex-wrap">
                    <a
                      href={release.html_url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-3xl font-bold hover:opacity-70 transition-opacity"
                    >
                      {release.tag_name}
                    </a>
                    {release.prerelease && (
                      <span class="px-2 py-0.5 text-xs font-medium bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 rounded">
                        Pre-release
                      </span>
                    )}
                    {index === 0 && !release.prerelease && (
                      <span class="px-2 py-0.5 text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded">
                        Latest
                      </span>
                    )}
                  </div>
                  <time datetime={release.published_at} class="mt-2 block text-sm opacity-60">
                    {formatDate(release.published_at)}
                  </time>
                </header>
                <div
                  class="release-content prose prose-sm dark:prose-invert max-w-none px-6 py-5
                         prose-headings:font-semibold prose-headings:text-black dark:prose-headings:text-white
                         prose-a:text-black dark:prose-a:text-white prose-a:underline"
                  set:html={parseMarkdown(release.body)}
                />
              </article>
            ))}
          </div>
        )}
      </main>

      <!-- Right Sidebar TOC -->
      <aside class="hidden lg:block">
        <nav class="sticky top-24 max-h-[calc(100vh-6rem)] overflow-y-auto">
          <h2 class="text-sm font-semibold mb-4 opacity-50 uppercase tracking-wider">Versions</h2>
          <ul class="space-y-1">
            {releases.map((release, index) => (
              <li>
                <a
                  href={`#${release.tag_name}`}
                  class="version-link text-sm opacity-60 hover:opacity-100 transition-opacity block py-1 flex items-center gap-2"
                  data-version={release.tag_name}
                >
                  <span>{release.tag_name}</span>
                  {index === 0 && !release.prerelease && (
                    <span class="px-1.5 py-0.5 text-[10px] font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded">Latest</span>
                  )}
                  {release.prerelease && (
                    <span class="px-1.5 py-0.5 text-[10px] font-medium bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 rounded">Pre-release</span>
                  )}
                </a>
              </li>
            ))}
          </ul>
        </nav>
      </aside>
    </div>
  </div>

  <Footer />
</BaseLayout>

<style>
  .version-link.active {
    opacity: 1;
    font-weight: 500;
  }

  /* Use theme colors for release content */
  .release-content code {
    background-color: var(--ez-gray-bg);
    border: 1px solid var(--ez-gray-border);
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
  }

  .release-content pre {
    background-color: var(--ez-gray-bg);
    border: 1px solid var(--ez-gray-border);
    border-radius: 0.5rem;
    padding: 1rem;
    overflow-x: auto;
  }
</style>

<script>
  function initChangelog() {
    const versionLinks = document.querySelectorAll('.version-link');
    const releaseEntries = document.querySelectorAll('.release-entry');

    if (releaseEntries.length === 0 || versionLinks.length === 0) return;

    // Set up intersection observer for active state
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const version = (entry.target as HTMLElement).dataset.version;

            // Remove active class from all links
            versionLinks.forEach((link) => link.classList.remove('active'));

            // Add active class to corresponding link
            const activeLink = document.querySelector(`.version-link[data-version="${version}"]`);
            if (activeLink) {
              activeLink.classList.add('active');
            }
          }
        });
      },
      {
        rootMargin: '-100px 0px -70% 0px',
        threshold: 0
      }
    );

    releaseEntries.forEach((entry) => observer.observe(entry));

    // Set first item as active initially
    if (versionLinks.length > 0) {
      versionLinks[0].classList.add('active');
    }
  }

  initChangelog();
  document.addEventListener('astro:after-swap', initChangelog);
</script>
