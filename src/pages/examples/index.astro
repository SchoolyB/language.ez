---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import CodeBlock from '../../components/CodeBlock.astro';
import fs from 'node:fs';
import path from 'node:path';

// Example metadata with categories
const exampleMeta = [
  // Basics
  { file: 'hello.ez', title: 'Hello World', category: 'Basics', description: 'Your first EZ program' },
  { file: 'variables.ez', title: 'Variables', category: 'Basics', description: 'Variable declarations and types' },
  { file: 'control_flow.ez', title: 'Control Flow', category: 'Basics', description: 'Conditionals and loops' },
  { file: 'functions.ez', title: 'Functions', category: 'Basics', description: 'Defining and calling functions' },
  { file: 'mutable_params.ez', title: 'Mutable Parameters', category: 'Basics', description: 'Using & to modify function parameters' },
  // Data Structures
  { file: 'arrays.ez', title: 'Arrays', category: 'Data Structures', description: 'Working with arrays' },
  { file: 'maps.ez', title: 'Maps', category: 'Data Structures', description: 'Working with key-value pairs' },
  { file: 'structs.ez', title: 'Structs', category: 'Data Structures', description: 'Custom data structures' },
  { file: 'enums.ez', title: 'Enums', category: 'Data Structures', description: 'Enumerations' },
  // Algorithms
  { file: 'fizzbuzz.ez', title: 'FizzBuzz', category: 'Algorithms', description: 'The classic FizzBuzz problem' },
  { file: 'fibonacci.ez', title: 'Fibonacci', category: 'Algorithms', description: 'The Fibonacci sequence' },
  { file: 'primes.ez', title: 'Prime Numbers', category: 'Algorithms', description: 'Finding prime numbers' },
  { file: 'calculator.ez', title: 'Calculator', category: 'Algorithms', description: 'A simple calculator' },
  // Standard Library
  { file: 'using_stdlib.ez', title: 'Standard Library', category: 'Standard Library', description: 'Using the built-in libraries' },
];

// Read example files
const examplesDir = path.join(process.cwd(), 'src', 'examples');
const examples = exampleMeta.map(meta => {
  const filePath = path.join(examplesDir, meta.file);
  const code = fs.readFileSync(filePath, 'utf-8');
  return { ...meta, code };
});

// Get unique categories in order
const categories = [...new Set(exampleMeta.map(e => e.category))];

// Create slug for IDs
const slugify = (str: string) => str.toLowerCase().replace(/\s+/g, '-');
---

<BaseLayout title="Examples - EZ" description="Real-world EZ code examples and recipes.">
  <Header />

  <div class="flex-1 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="lg:grid lg:grid-cols-[1fr_200px] lg:gap-8">
      <!-- Main Content -->
      <main class="min-w-0">
        <div class="flex items-center justify-between mb-2">
          <h1 class="text-3xl font-bold">Examples</h1>
          <button
            id="toggle-all-btn"
            class="text-sm px-3 py-1.5 rounded border border-[#e5e5e5] dark:border-[#333333] hover:bg-[#f5f5f5] dark:hover:bg-[#1a1a1a] transition-colors"
          >
            Expand All
          </button>
        </div>
        <p class="opacity-60 mb-6">
          Real, copy-paste-ready code for common tasks. Click an example to view the code.
        </p>

        <!-- Examples by Category -->
        {categories.map(category => (
          <section id={slugify(category)} class="mb-12 example-section" data-category={category.toLowerCase()}>
            <h2 class="text-xl font-semibold mb-6 opacity-60">{category}</h2>
            <div class="space-y-3">
              {examples.filter(e => e.category === category).map(example => (
                <div
                  id={slugify(example.title)}
                  class="example-card border border-[#e5e5e5] dark:border-[#333333] rounded-lg overflow-hidden"
                  data-title={example.title.toLowerCase()}
                  data-description={example.description.toLowerCase()}
                >
                  <button
                    class="example-toggle w-full px-4 py-3 bg-[#f5f5f5] dark:bg-[#1a1a1a] flex items-center justify-between gap-2 text-left hover:bg-[#ebebeb] dark:hover:bg-[#252525] transition-colors"
                    data-example-id={slugify(example.title)}
                  >
                    <div class="min-w-0 flex-1">
                      <h3 class="font-semibold truncate">{example.title}</h3>
                      <p class="text-sm opacity-50 truncate">{example.description}</p>
                    </div>
                    <svg
                      class="example-chevron w-5 h-5 opacity-50 transition-transform duration-200 flex-shrink-0"
                      data-chevron-id={slugify(example.title)}
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                  </button>
                  <div
                    class="example-content hidden"
                    data-content-id={slugify(example.title)}
                  >
                    <div class="border-t border-[#e5e5e5] dark:border-[#333333]">
                      <div class="flex justify-end px-4 py-2 bg-[#f5f5f5] dark:bg-[#1a1a1a] border-b border-[#e5e5e5] dark:border-[#333333]">
                        <button
                          class="copy-btn text-sm px-3 py-1 rounded border border-[#e5e5e5] dark:border-[#333333] hover:bg-[#f5f5f5] dark:hover:bg-[#1a1a1a] transition-colors"
                          data-code={example.code}
                        >
                          Copy
                        </button>
                      </div>
                      <CodeBlock code={example.code} />
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </section>
        ))}
      </main>

      <!-- Right Sidebar TOC -->
      <aside class="hidden lg:block">
        <nav class="sticky top-24 max-h-[calc(100vh-6rem)] overflow-y-auto">
          <h2 class="text-sm font-semibold mb-4 opacity-50 uppercase tracking-wider">On This Page</h2>
          <ul class="space-y-3">
            {categories.map(category => (
              <li>
                <a href={`#${slugify(category)}`} class="text-sm font-medium opacity-70 hover:opacity-100 transition-opacity">
                  {category}
                </a>
                <ul class="mt-1 ml-3 space-y-1">
                  {examples.filter(e => e.category === category).map(example => (
                    <li>
                      <a
                        href={`#${slugify(example.title)}`}
                        class="example-toc-link text-sm opacity-50 hover:opacity-100 transition-opacity block py-0.5"
                        data-title={example.title.toLowerCase()}
                      >
                        {example.title}
                      </a>
                    </li>
                  ))}
                </ul>
              </li>
            ))}
          </ul>
        </nav>
      </aside>
    </div>
  </div>

  <Footer />
</BaseLayout>

<style>
  .example-chevron.open {
    transform: rotate(180deg);
  }
</style>

<script>
  function initExamples() {
    const toggleAllBtn = document.getElementById('toggle-all-btn');
    const exampleToggles = document.querySelectorAll('.example-toggle');
    const copyButtons = document.querySelectorAll('.copy-btn');

    let allExpanded = false;

    // Toggle individual example
    exampleToggles.forEach(toggle => {
      toggle.addEventListener('click', () => {
        const id = (toggle as HTMLElement).dataset.exampleId;
        const content = document.querySelector(`[data-content-id="${id}"]`);
        const chevron = document.querySelector(`[data-chevron-id="${id}"]`);

        if (content && chevron) {
          content.classList.toggle('hidden');
          chevron.classList.toggle('open');
        }

        // Update toggle all button text
        updateToggleAllButton();
      });
    });

    // Toggle all examples
    toggleAllBtn?.addEventListener('click', () => {
      allExpanded = !allExpanded;

      document.querySelectorAll('.example-content').forEach(content => {
        if (allExpanded) {
          content.classList.remove('hidden');
        } else {
          content.classList.add('hidden');
        }
      });

      document.querySelectorAll('.example-chevron').forEach(chevron => {
        if (allExpanded) {
          chevron.classList.add('open');
        } else {
          chevron.classList.remove('open');
        }
      });

      updateToggleAllButton();
    });

    function updateToggleAllButton() {
      const allContents = document.querySelectorAll('.example-content');
      const expandedCount = document.querySelectorAll('.example-content:not(.hidden)').length;

      if (toggleAllBtn) {
        if (expandedCount === allContents.length) {
          toggleAllBtn.textContent = 'Collapse All';
          allExpanded = true;
        } else if (expandedCount === 0) {
          toggleAllBtn.textContent = 'Expand All';
          allExpanded = false;
        } else {
          toggleAllBtn.textContent = 'Collapse All';
          allExpanded = true;
        }
      }
    }

    // Copy functionality
    copyButtons.forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation(); // Prevent toggle when clicking copy
        const code = btn.getAttribute('data-code');
        if (code) {
          await navigator.clipboard.writeText(code);
          const originalText = btn.textContent;
          btn.textContent = 'Copied!';
          setTimeout(() => {
            btn.textContent = originalText;
          }, 2000);
        }
      });
    });
  }

  initExamples();
  document.addEventListener('astro:after-swap', initExamples);
</script>
