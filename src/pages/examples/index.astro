---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import CodeBlock from '../../components/CodeBlock.astro';
import fs from 'node:fs';
import path from 'node:path';

// Example metadata with categories
const exampleMeta = [
  // Basics
  { file: 'hello.ez', title: 'Hello World', category: 'Basics', description: 'Your first EZ program' },
  { file: 'variables.ez', title: 'Variables', category: 'Basics', description: 'Variable declarations and types' },
  { file: 'control_flow.ez', title: 'Control Flow', category: 'Basics', description: 'Conditionals and loops' },
  { file: 'functions.ez', title: 'Functions', category: 'Basics', description: 'Defining and calling functions' },
  // Data Structures
  { file: 'arrays.ez', title: 'Arrays', category: 'Data Structures', description: 'Working with arrays' },
  { file: 'maps.ez', title: 'Maps', category: 'Data Structures', description: 'Working with key-value pairs' },
  { file: 'structs.ez', title: 'Structs', category: 'Data Structures', description: 'Custom data structures' },
  { file: 'enums.ez', title: 'Enums', category: 'Data Structures', description: 'Enumerations' },
  // Algorithms
  { file: 'fizzbuzz.ez', title: 'FizzBuzz', category: 'Algorithms', description: 'The classic FizzBuzz problem' },
  { file: 'fibonacci.ez', title: 'Fibonacci', category: 'Algorithms', description: 'The Fibonacci sequence' },
  { file: 'primes.ez', title: 'Prime Numbers', category: 'Algorithms', description: 'Finding prime numbers' },
  { file: 'calculator.ez', title: 'Calculator', category: 'Algorithms', description: 'A simple calculator' },
  // Standard Library
  { file: 'using_stdlib.ez', title: 'Standard Library', category: 'Standard Library', description: 'Using the built-in libraries' },
];

// Read example files
const examplesDir = path.join(process.cwd(), 'src', 'examples');
const examples = exampleMeta.map(meta => {
  const filePath = path.join(examplesDir, meta.file);
  const code = fs.readFileSync(filePath, 'utf-8');
  return { ...meta, code };
});

// Get unique categories in order
const categories = [...new Set(exampleMeta.map(e => e.category))];

// Create slug for IDs
const slugify = (str: string) => str.toLowerCase().replace(/\s+/g, '-');
---

<BaseLayout title="Examples - EZ" description="Real-world EZ code examples and recipes.">
  <Header />

  <div class="flex-1 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="lg:grid lg:grid-cols-[1fr_200px] lg:gap-8">
      <!-- Main Content -->
      <main class="min-w-0">
        <h1 class="text-3xl font-bold mb-2">Examples</h1>
        <p class="opacity-60 mb-6">
          Real, copy-paste-ready code for common tasks. Each example is self-contained and runnable.
        </p>

        <!-- Examples by Category -->
        {categories.map(category => (
          <section id={slugify(category)} class="mb-12 example-section" data-category={category.toLowerCase()}>
            <h2 class="text-xl font-semibold mb-6 opacity-60">{category}</h2>
            <div class="space-y-6">
              {examples.filter(e => e.category === category).map(example => (
                <div
                  id={slugify(example.title)}
                  class="example-card border border-[#e5e5e5] dark:border-[#333333] rounded-lg overflow-hidden"
                  data-title={example.title.toLowerCase()}
                  data-description={example.description.toLowerCase()}
                >
                  <div class="px-4 py-3 bg-[#f5f5f5] dark:bg-[#1a1a1a] border-b border-[#e5e5e5] dark:border-[#333333] flex items-center justify-between gap-2">
                    <div class="min-w-0 flex-1">
                      <h3 class="font-semibold truncate">{example.title}</h3>
                      <p class="text-sm opacity-50 truncate">{example.description}</p>
                    </div>
                    <button
                      class="copy-btn text-sm px-3 py-1 rounded border border-gray-300 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors flex-shrink-0"
                      data-code={example.code}
                    >
                      Copy
                    </button>
                  </div>
                  <CodeBlock code={example.code} />
                </div>
              ))}
            </div>
          </section>
        ))}
      </main>

      <!-- Right Sidebar TOC -->
      <aside class="hidden lg:block">
        <nav class="sticky top-24 max-h-[calc(100vh-6rem)] overflow-y-auto">
          <h2 class="text-sm font-semibold mb-4 opacity-50 uppercase tracking-wider">On This Page</h2>
          <ul class="space-y-3">
            {categories.map(category => (
              <li>
                <a href={`#${slugify(category)}`} class="text-sm font-medium opacity-70 hover:opacity-100 transition-opacity">
                  {category}
                </a>
                <ul class="mt-1 ml-3 space-y-1">
                  {examples.filter(e => e.category === category).map(example => (
                    <li>
                      <a
                        href={`#${slugify(example.title)}`}
                        class="example-toc-link text-sm opacity-50 hover:opacity-100 transition-opacity block py-0.5"
                        data-title={example.title.toLowerCase()}
                      >
                        {example.title}
                      </a>
                    </li>
                  ))}
                </ul>
              </li>
            ))}
          </ul>
        </nav>
      </aside>
    </div>
  </div>

  <Footer />
</BaseLayout>

<script>
  function initExamples() {
    const copyButtons = document.querySelectorAll('.copy-btn');

    // Copy functionality
    copyButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const code = btn.getAttribute('data-code');
        if (code) {
          await navigator.clipboard.writeText(code);
          const originalText = btn.textContent;
          btn.textContent = 'Copied!';
          setTimeout(() => {
            btn.textContent = originalText;
          }, 2000);
        }
      });
    });
  }

  initExamples();
  document.addEventListener('astro:after-swap', initExamples);
</script>
