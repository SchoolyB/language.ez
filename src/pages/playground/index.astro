---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';

const base = import.meta.env.BASE_URL;

// Example programs
const examples = {
  hello: `/*
 * Hello World - Your first EZ program
 */

import @std
using std

do main() {
    println("Hello, World!")
}`,

  fibonacci: `/*
 * Fibonacci Sequence
 * Each number is the sum of the two preceding ones.
 */

import @std
using std

do main() {
    println("=== Fibonacci Sequence ===")

    // Print first 15 Fibonacci numbers
    for i in range(0, 15) {
        println("fib(\${i}) = \${fibonacci(i)}")
    }
}

// Recursive Fibonacci
do fibonacci(n int) -> int {
    if n <= 0 {
        return 0
    }
    if n == 1 {
        return 1
    }
    return fibonacci(n - 1) + fibonacci(n - 2)
}`,

  fizzbuzz: `/*
 * FizzBuzz - Classic programming challenge
 */

import @std
using std

do main() {
    println("=== FizzBuzz ===")

    for i in range(1, 31) {
        if i % 15 == 0 {
            println("FizzBuzz")
        } or i % 3 == 0 {
            println("Fizz")
        } or i % 5 == 0 {
            println("Buzz")
        } otherwise {
            println(i)
        }
    }
}`,

  structs: `/*
 * Structs - Custom data types
 */

import @std
using std

const Point struct {
    x int
    y int
}

const Person struct {
    name string
    age int
    location Point
}

do main() {
    temp p = Person{
        name: "Alice",
        age: 30,
        location: Point{x: 10, y: 20}
    }

    println("Name: \${p.name}")
    println("Age: \${p.age}")
    println("Location: (\${p.location.x}, \${p.location.y})")
}`,

  enums: `/*
 * Enums and Pattern Matching
 */

import @std
using std

const Color enum {
    Red = 1
    Green = 2
    Blue = 3
}

do main() {
    temp c = Color.Green

    when c {
        is Color.Red {
            println("The color is red!")
        }
        is Color.Green {
            println("The color is green!")
        }
        is Color.Blue {
            println("The color is blue!")
        }
        default {
            println("Unknown color")
        }
    }
}`
};
---

<BaseLayout title="EZ Playground" description="Write and run EZ code in your browser">
  <Header />

  <main class="flex-1 flex flex-col" style="height: calc(100vh - 64px);">
    <!-- Toolbar -->
    <div class="flex items-center justify-between px-4 py-3 border-b border-[#e5e5e5] dark:border-[#333333] bg-[#f5f5f5] dark:bg-[#1a1a1a]">
      <div class="flex items-center gap-4">
        <h1 class="text-lg font-semibold text-black dark:text-white">EZ Playground</h1>
        <span id="wasm-status" class="text-sm text-amber-600 dark:text-amber-400">Loading...</span>
      </div>

      <div class="flex items-center gap-3">
        <select id="examples" class="px-3 py-1.5 text-sm rounded-md border border-[#e5e5e5] dark:border-[#333333] bg-white dark:bg-black text-black dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <option value="">Load Example...</option>
          <option value="hello">Hello World</option>
          <option value="fibonacci">Fibonacci</option>
          <option value="fizzbuzz">FizzBuzz</option>
          <option value="structs">Structs</option>
          <option value="enums">Enums</option>
        </select>

        <button id="run-btn" class="px-4 py-1.5 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Run
        </button>
      </div>
    </div>

    <!-- Editor and Output -->
    <div class="flex-1 grid grid-cols-1 lg:grid-cols-2 min-h-0">
      <!-- Editor Panel -->
      <div class="flex flex-col border-r border-[#e5e5e5] dark:border-[#333333] min-h-0">
        <div class="px-4 py-2 text-sm font-medium text-black/60 dark:text-white/60 bg-[#fafafa] dark:bg-[#0d0d0d] border-b border-[#e5e5e5] dark:border-[#333333]">
          Code
        </div>
        <div id="editor" class="flex-1 min-h-0 overflow-auto"></div>
      </div>

      <!-- Output Panel -->
      <div class="flex flex-col min-h-0">
        <div class="px-4 py-2 text-sm font-medium text-black/60 dark:text-white/60 bg-[#fafafa] dark:bg-[#0d0d0d] border-b border-[#e5e5e5] dark:border-[#333333] flex items-center justify-between">
          <span>Output</span>
          <button id="clear-btn" class="text-xs text-black/40 dark:text-white/40 hover:text-black dark:hover:text-white transition-colors">
            Clear
          </button>
        </div>
        <pre id="output" class="flex-1 min-h-0 overflow-auto p-4 font-mono text-sm bg-white dark:bg-black text-black dark:text-white whitespace-pre-wrap"></pre>
      </div>
    </div>
  </main>
</BaseLayout>

<style>
  /* CodeMirror container styling */
  #editor :global(.cm-editor) {
    height: 100%;
    font-size: 14px;
  }

  #editor :global(.cm-scroller) {
    font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  }

  /* Light theme adjustments */
  #editor :global(.cm-editor.cm-focused) {
    outline: none;
  }

  /* Error output styling */
  .error-output {
    color: #dc2626;
  }

  .dark .error-output {
    color: #f87171;
  }
</style>

<script define:vars={{ examples, base }}>
  // Store examples for use in the script
  window.ezExamples = examples;
  window.ezBase = base;
</script>

<script>
  import { EditorView, basicSetup } from 'codemirror';
  import { EditorState } from '@codemirror/state';
  import { keymap } from '@codemirror/view';
  import { indentWithTab } from '@codemirror/commands';
  import { oneDark } from '@codemirror/theme-one-dark';
  import { StreamLanguage } from '@codemirror/language';

  // Simple EZ language mode
  const ezLanguage = StreamLanguage.define({
    token(stream, state) {
      // Skip whitespace
      if (stream.eatSpace()) return null;

      // Comments
      if (stream.match('//')) {
        stream.skipToEnd();
        return 'comment';
      }
      if (stream.match('/*')) {
        while (!stream.match('*/') && !stream.eol()) {
          stream.next();
        }
        return 'comment';
      }

      // Strings
      if (stream.match('"')) {
        while (!stream.eol()) {
          if (stream.next() === '"') break;
        }
        return 'string';
      }
      if (stream.match("'")) {
        while (!stream.eol()) {
          if (stream.next() === "'") break;
        }
        return 'string';
      }
      if (stream.match('`')) {
        while (!stream.eol()) {
          if (stream.next() === '`') break;
        }
        return 'string';
      }

      // Numbers
      if (stream.match(/^-?\d+(\.\d+)?/)) {
        return 'number';
      }

      // Module imports (@std, @strings, etc.)
      if (stream.match(/@\w+/)) {
        return 'namespace';
      }

      // Keywords
      const keywords = ['do', 'temp', 'const', 'if', 'or', 'otherwise', 'for', 'for_each',
                       'as_long_as', 'when', 'is', 'default', 'return', 'break', 'continue',
                       'import', 'using', 'struct', 'enum', 'in', 'range', 'module', 'ensure',
                       'true', 'false', 'nil', 'ref', 'copy'];

      // Types
      const types = ['int', 'float', 'string', 'bool', 'char', 'byte', 'error', 'Error',
                    'i8', 'i16', 'i32', 'i64', 'u8', 'u16', 'u32', 'u64', 'func'];

      // Check for identifiers and keywords
      if (stream.match(/^[a-zA-Z_]\w*/)) {
        const word = stream.current();
        if (keywords.includes(word)) return 'keyword';
        if (types.includes(word)) return 'type';
        return 'variable';
      }

      // Operators
      if (stream.match(/^[+\-*/%=<>!&|]+/)) {
        return 'operator';
      }

      stream.next();
      return null;
    }
  });

  let editor: EditorView | null = null;
  let wasmReady = false;

  // Initialize the editor
  function initEditor() {
    const editorContainer = document.getElementById('editor');
    if (!editorContainer || editor) return;

    const isDark = document.documentElement.classList.contains('dark');
    const defaultCode = (window as any).ezExamples?.hello || '// Write your EZ code here\n\nimport @std\nusing std\n\ndo main() {\n    println("Hello, World!")\n}';

    const extensions = [
      basicSetup,
      keymap.of([indentWithTab]),
      ezLanguage,
      EditorView.lineWrapping,
    ];

    if (isDark) {
      extensions.push(oneDark);
    }

    editor = new EditorView({
      state: EditorState.create({
        doc: defaultCode,
        extensions
      }),
      parent: editorContainer
    });
  }

  // Initialize WASM
  async function initWasm() {
    const statusEl = document.getElementById('wasm-status');
    const runBtn = document.getElementById('run-btn') as HTMLButtonElement;

    try {
      if (statusEl) statusEl.textContent = 'Loading WASM...';
      if (runBtn) runBtn.disabled = true;

      // Load wasm_exec.js
      const base = (window as any).ezBase || '/';
      await new Promise<void>((resolve, reject) => {
        const script = document.createElement('script');
        script.src = `${base}wasm/wasm_exec.js`;
        script.onload = () => resolve();
        script.onerror = () => reject(new Error('Failed to load wasm_exec.js'));
        document.head.appendChild(script);
      });

      // Initialize Go runtime and load WASM
      const go = new (window as any).Go();
      const result = await WebAssembly.instantiateStreaming(
        fetch(`${base}wasm/ez.wasm`),
        go.importObject
      );

      // Run the Go program (this registers executeEZ)
      go.run(result.instance);

      wasmReady = true;
      if (statusEl) {
        statusEl.textContent = 'Ready';
        statusEl.className = 'text-sm text-green-600 dark:text-green-400';
      }
      if (runBtn) runBtn.disabled = false;

    } catch (error) {
      console.error('Failed to initialize WASM:', error);
      if (statusEl) {
        statusEl.textContent = 'Failed to load';
        statusEl.className = 'text-sm text-red-600 dark:text-red-400';
      }
    }
  }

  // Run the code
  function runCode() {
    if (!wasmReady || !editor) return;

    const outputEl = document.getElementById('output');
    if (!outputEl) return;

    const code = editor.state.doc.toString();
    outputEl.textContent = '';
    outputEl.className = outputEl.className.replace(/error-output/g, '').trim();

    // Capture console output (Go WASM writes to console.log/console.error)
    const capturedOutput: string[] = [];
    const capturedErrors: string[] = [];

    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;

    console.log = (...args) => {
      capturedOutput.push(args.map(a => String(a)).join(' '));
    };
    console.error = (...args) => {
      capturedErrors.push(args.map(a => String(a)).join(' '));
    };
    console.warn = (...args) => {
      capturedErrors.push(args.map(a => String(a)).join(' '));
    };

    try {
      const result = (window as any).executeEZ(code);

      // Restore console
      console.log = originalLog;
      console.error = originalError;
      console.warn = originalWarn;

      // Combine captured output with any returned output
      const stdout = capturedOutput.join('\n') + (result.output || '');
      const stderr = capturedErrors.join('\n') + (result.error || '');

      if (stdout.trim()) {
        outputEl.textContent = stdout;
      }

      if (stderr.trim()) {
        if (outputEl.textContent) {
          outputEl.textContent += '\n' + stderr;
        } else {
          outputEl.textContent = stderr;
        }
        outputEl.className += ' error-output';
      }

      if (!stdout.trim() && !stderr.trim()) {
        outputEl.textContent = '(No output)';
        outputEl.style.opacity = '0.5';
      } else {
        outputEl.style.opacity = '1';
      }

    } catch (error) {
      // Restore console on error
      console.log = originalLog;
      console.error = originalError;
      console.warn = originalWarn;

      outputEl.textContent = `Error: ${error}`;
      outputEl.className += ' error-output';
    }
  }

  // Load example code
  function loadExample(name: string) {
    if (!editor || !name) return;

    const examples = (window as any).ezExamples;
    const code = examples?.[name];
    if (!code) return;

    editor.dispatch({
      changes: {
        from: 0,
        to: editor.state.doc.length,
        insert: code
      }
    });

    // Reset example selector
    const select = document.getElementById('examples') as HTMLSelectElement;
    if (select) select.value = '';
  }

  // Clear output
  function clearOutput() {
    const outputEl = document.getElementById('output');
    if (outputEl) {
      outputEl.textContent = '';
      outputEl.style.opacity = '1';
      outputEl.className = outputEl.className.replace(/error-output/g, '').trim();
    }
  }

  // Setup event listeners
  function setupListeners() {
    const runBtn = document.getElementById('run-btn');
    const examplesSelect = document.getElementById('examples');
    const clearBtn = document.getElementById('clear-btn');

    runBtn?.addEventListener('click', runCode);
    examplesSelect?.addEventListener('change', (e) => {
      loadExample((e.target as HTMLSelectElement).value);
    });
    clearBtn?.addEventListener('click', clearOutput);

    // Keyboard shortcut: Ctrl/Cmd + Enter to run
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        runCode();
      }
    });
  }

  // Initialize everything
  function init() {
    initEditor();
    initWasm();
    setupListeners();
  }

  // Handle theme changes
  function handleThemeChange() {
    // Reinitialize editor with new theme
    const editorContainer = document.getElementById('editor');
    if (editorContainer && editor) {
      const code = editor.state.doc.toString();
      editor.destroy();
      editor = null;
      editorContainer.innerHTML = '';

      const isDark = document.documentElement.classList.contains('dark');
      const extensions = [
        basicSetup,
        keymap.of([indentWithTab]),
        ezLanguage,
        EditorView.lineWrapping,
      ];

      if (isDark) {
        extensions.push(oneDark);
      }

      editor = new EditorView({
        state: EditorState.create({
          doc: code,
          extensions
        }),
        parent: editorContainer
      });
    }
  }

  // Watch for theme changes
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'class') {
        handleThemeChange();
      }
    });
  });

  init();
  observer.observe(document.documentElement, { attributes: true });

  // Reinitialize on Astro page transitions
  document.addEventListener('astro:after-swap', () => {
    editor = null;
    wasmReady = false;
    init();
  });
</script>
