---
// Table of Contents component
// Headings are extracted client-side from the page content
---

<aside class="toc-container hidden xl:block w-56 shrink-0">
  <nav class="toc-nav sticky top-20 max-h-[calc(100vh-5rem)] overflow-y-auto">
    <h4 class="text-sm font-semibold uppercase tracking-wider opacity-50 mb-3 text-black dark:text-white">
      On This Page
    </h4>
    <ul class="toc-list space-y-1.5 text-base" id="toc-list">
      <!-- Populated by JavaScript -->
    </ul>
  </nav>
</aside>

<script>
  function buildTOC() {
    const tocList = document.getElementById('toc-list');
    const article = document.querySelector('.docs-content');

    if (!tocList || !article) return;

    // Clear existing TOC
    tocList.innerHTML = '';

    // Get all h2 and h3 headings
    const headings = article.querySelectorAll('h2, h3');

    if (headings.length === 0) {
      // Hide TOC if no headings
      const container = document.querySelector('.toc-container');
      if (container) container.style.display = 'none';
      return;
    }

    headings.forEach((heading, index) => {
      // Ensure heading has an ID for linking
      if (!heading.id) {
        heading.id = `heading-${index}`;
      }

      const li = document.createElement('li');
      const a = document.createElement('a');

      a.href = `#${heading.id}`;
      a.textContent = heading.textContent;
      a.className = 'toc-link';
      a.dataset.headingId = heading.id;

      // Indent h3 headings
      if (heading.tagName === 'H3') {
        li.className = 'pl-3';
      }

      li.appendChild(a);
      tocList.appendChild(li);
    });

    // Set up intersection observer for active state
    setupScrollSpy();
  }

  function setupScrollSpy() {
    const headings = document.querySelectorAll('.docs-content h2, .docs-content h3');
    const tocLinks = document.querySelectorAll('.toc-link');

    if (headings.length === 0 || tocLinks.length === 0) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            // Remove active class from all links
            tocLinks.forEach((link) => link.classList.remove('active'));

            // Add active class to corresponding link
            const activeLink = document.querySelector(
              `.toc-link[data-heading-id="${entry.target.id}"]`
            );
            if (activeLink) {
              activeLink.classList.add('active');
            }
          }
        });
      },
      {
        rootMargin: '-80px 0px -70% 0px',
        threshold: 0
      }
    );

    headings.forEach((heading) => observer.observe(heading));
  }

  // Generate IDs from heading text
  function slugify(text: string): string {
    return text
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/(^-|-$)/g, '');
  }

  // Assign IDs to headings that don't have them
  function assignHeadingIds() {
    const article = document.querySelector('.docs-content');
    if (!article) return;

    const headings = article.querySelectorAll('h2, h3');
    const usedIds = new Set<string>();

    headings.forEach((heading) => {
      if (!heading.id) {
        let baseId = slugify(heading.textContent || '');
        let id = baseId;
        let counter = 1;

        // Ensure unique IDs
        while (usedIds.has(id)) {
          id = `${baseId}-${counter}`;
          counter++;
        }

        heading.id = id;
        usedIds.add(id);
      } else {
        usedIds.add(heading.id);
      }
    });
  }

  // Initialize
  assignHeadingIds();
  buildTOC();

  // Re-run after Astro page transitions
  document.addEventListener('astro:after-swap', () => {
    assignHeadingIds();
    buildTOC();
  });
</script>
